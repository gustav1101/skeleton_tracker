<?xml version="1.0"?>
<launch>
  <arg name="scatter_step_distance" value="1" />
  <arg name="scatter_steps" value="6" />
  <arg name="calibration_messages" value="10" />
  <arg name="resolution" value="368x368" />
  <arg name="xtion1_active" default="true" />
  <arg name="xtion2_active" default="false" />
  <arg name="kinect2_active" default="true" />



  <!-- ++++++++++++++++++++++++++ LAUNCH CAMERAS +++++++++++++++++++++++++++++++++++++++++ -->
  
  <include file="$(find sensorlab_launch)/launch/sensorlab_startup.launch" />
  
  <!-- ++++++++++++++++++++++++++ KINECT2 ON LOCAL DEVICE ++++++++++++++++++++++++++++++++ -->
  <group ns="kinect2" if="$(arg kinect2_active)" >

    <node name="pose_estimator" pkg="tfpose_ros" type="broadcaster_ros.py" output="screen" required="true" >
      <env name="CUDA_VISIBLE_DEVICES" value="0" />
      <param name="camera" value="sd/image_color_rect" />
      <param name="model" value="mobilenet_thin" />
      <param name="resolution" value="$(arg resolution)" />
    </node>

    <node name="skeleton_to_3d" pkg="skeleton3d" type="skeleton_sensor" output="screen" required="true" >
      <param name="input_pose" type="str" value="pose_estimator/pose" />
      <param name="input_pointcloud" type="str" value="sd/points" />
      <param name="output_skeleton" type="str" value="/repository/skeleton_input" />
      <param name="camera_name" type="str" value="kinect2" />
      <param name="scatter_step_distance" type="int" value="$(arg scatter_step_distance)" />
      <param name="scatter_steps" type="int" value="$(arg scatter_steps)" />
      <param name="frame_id" type="str" value="kinect2_link" />
      <param name="number_of_calibration_messages" type="int" value="$(arg calibration_messages)" />
    </node>

  </group>
  <!-- ++++++++++++++++++++++++++ XTION1 ON ODROID1 ++++++++++++++++++++++++++++++++++++++ -->
  <group ns="xtion1" if="$(arg xtion1_active)">
    
    <node name="pose_estimator" pkg="tfpose_ros" type="broadcaster_ros.py" output="screen" required="true">
      <env name="CUDA_VISIBLE_DEVICES" value="2" />
      <param name="camera" value="rgb/image_rect_color" />
      <param name="model" value="mobilenet_thin" />
      <param name="resolution" value="$(arg resolution)" />
    </node>

    <node name="skeleton_to_3d" pkg="skeleton3d" type="skeleton_sensor" output="screen" required="true">
      <param name="input_pose" type="str" value="pose_estimator/pose" />
      <param name="input_pointcloud" type="str" value="depth_registered/points" />
      <param name="output_skeleton" type="str" value="/repository/skeleton_input" />
      <param name="camera_name" type="str" value="xtion1" />
      <param name="scatter_step_distance" type="int" value="$(arg scatter_step_distance)" />
      <param name="scatter_steps" type="int" value="$(arg scatter_steps)" />
      <param name="frame_id" type="str" value="xtion1_depth_optical_frame" />
      <param name="number_of_calibration_messages" type="int" value="$(arg calibration_messages)" />
    </node>

  </group>
  <!-- ++++++++++++++++++++++++++ XTION2 ON ODROID2 ++++++++++++++++++++++++++++++++++++++ -->
  <group ns="xtion2" if="$(arg xtion2_active)">

    <node name="pose_estimator" pkg="tfpose_ros" type="broadcaster_ros.py" output="screen" required="true" >
      <env name="CUDA_VISIBLE_DEVICES" value="1" />
      <param name="camera" value="rgb/image_rect_color" />
      <param name="model" value="mobilenet_thin" />
      <param name="resolution" value="$(arg resolution)" />
    </node>

    <node name="skeleton_to_3d" pkg="skeleton3d" type="skeleton_sensor" output="screen" required="true">
      <param name="input_pose" type="str" value="pose_estimator/pose" />
      <param name="input_pointcloud" type="str" value="depth_registered/points" />
      <param name="output_skeleton" type="str" value="/repository/skeleton_input" />
      <param name="camera_name" type="str" value="xtion2" />
      <param name="scatter_step_distance" type="int" value="$(arg scatter_step_distance)" />
      <param name="scatter_steps" type="int" value="$(arg scatter_steps)" />
      <param name="frame_id" type="str" value="xtion2_depth_optical_frame" />
      <param name="number_of_calibration_messages" type="int" value="$(arg calibration_messages)" />
    </node>

  </group>
  <!-- +++++++++++++++++++ REPOSITORY AND CENTRAL INFRASTRUCTURE +++++++++++++++++++++++++ -->
  
  <node name="skeleton_repository" pkg="skeleton3d" type="skeleton_repository" output="screen" ns="repository" required="true" launch-prefix="xterm -e gdb --args" >
    <param name="position_tolerance" type="double" value="1.2" />
    <param name="skeleton_input" type="str" value="skeleton_input" />
    <param name="masterlist_output" type="str" value="masterlist" />
    <param name="publish_interval" type="double" value="0.08" />
    <param name="global_frame_id" type="str" value="world" />
    <param name="decay_strength" type="double" value="2.0" />
  </node>

  <node name="skeleton_visualiser" pkg="skeleton3d" type="skeleton_visualiser" output="screen" ns="repository" required="true" >
    <param name="input_skeleton" type="str" value="masterlist" />
    <param name = "output_marker" type="str" value="skeleton_vis" />
    <param name="frame_id" type="str" value="world" />
  </node>

  <node type="rviz" name="rviz" pkg="rviz" args="-d $(find skeleton3d)/rviz/live_multicam.rviz" />
</launch>
